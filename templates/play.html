<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>BainsyBuilds AR Darts</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
    <style>
      #cal-panel {
        max-width: 900px;
        margin: 16px auto;
        padding: 12px 16px;
        background: #1e1e1e;
        color: #ddd;
        border: 1px solid #333;
        border-radius: 8px;
        font-size: 14px;
      }
      #cal-panel .row {
        display: flex;
        align-items: center;
        gap: 12px;
        margin: 8px 0;
        flex-wrap: wrap;
      }
      #cal-panel input[type="range"] {
        width: 280px;
      }
      #cal-panel input[type="number"] {
        width: 90px;
      }
      #cal-panel label {
        min-width: 180px;
      }
      #cal-panel .val {
        color: #9fe2ff;
        min-width: 48px;
        display: inline-block;
        text-align: right;
      }
      #ruler {
        width: 400px;
        height: 8px;
        background: linear-gradient(90deg, #fff 0 50%, #000 50% 100%);
        background-size: 10px 8px;
        border: 1px solid #555;
      }
      #board-container {
        position: relative;
        overflow: hidden;
      }
      #board-bg {
        position: absolute;
        inset: 0;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        z-index: 0;
        pointer-events: none;
      }
      #board-bg.atw {
        background-image: url("{{ url_for('static', filename='images/beach.png') }}");
      }
      #board-bg.x01 {
        background-image: url("{{ url_for('static', filename='images/x01Back.jpg') }}");
      }
      #dartboard {
        position: relative;
        z-index: 1;
      }
      #overlay {
        position: absolute;
        inset: 0;
        z-index: 2;
      }
      .btn-ready {
        background: #00cc66;
        color: white;
        border: none;
        padding: 10px 24px;
        font-size: 1rem;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        animation: pulse 1.2s infinite;
      }
      .btn-ready:disabled {
        background: #555;
        animation: none;
        cursor: not-allowed;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.6;
        }
      }
    </style>
  </head>
  <body>
    <button
      id="btn-cal"
      class="btn btn-ghost"
      style="position: fixed; right: 16px; top: 16px; z-index: 3"
    >
      âš™ï¸Ž Calibrate
    </button>
    <h1>BainsyBuilds AR Darts</h1>

    <div id="board-container">
      <div
        id="board-bg"
        class="{{ 'x01' if game == 'x01' else 'atw' }}"
        aria-hidden="true"
      ></div>
      <img
        src="{{ url_for('static', filename='images/x01dartboard.png') if game == 'x01' else url_for('static', filename='images/dartboard.png') }}"
        id="dartboard"
        alt="Dartboard"
      />
      <canvas id="overlay"></canvas>
      <div id="turn-badge" class="turn-badge" aria-live="polite">
        Player 1 to throw
      </div>
      <div
        id="hud-left"
        class="hud-side left"
        aria-live="polite"
        aria-label="Player 1 HUD"
      >
        <div class="card" id="p1-card">
          <div class="p-name" id="p1-name">Player 1</div>
          <div class="p-line">
            <span class="label">Target:</span>
            <span id="p1-target">To hit: 1</span>
          </div>
          <div class="p-line" id="p1-last" aria-live="polite">Last hit: â€”</div>
          <div class="p-line" id="p1-throws" aria-live="polite">
            Throws: ðŸŽ¯ ðŸŽ¯ ðŸŽ¯
          </div>
        </div>
      </div>
      <div
        id="hud-right"
        class="hud-side right"
        aria-live="polite"
        aria-label="Player 2 HUD"
      >
        <div class="card" id="p2-card">
          <div class="p-name" id="p2-name">Player 2</div>
          <div class="p-line">
            <span class="label">Target:</span>
            <span id="p2-target">To hit: 1</span>
          </div>
          <div class="p-line" id="p2-last" aria-live="polite">Last hit: â€”</div>
          <div class="p-line" id="p2-throws" aria-live="polite">
            Throws: ðŸŽ¯ ðŸŽ¯ ðŸŽ¯
          </div>
        </div>
      </div>
    </div>

    <!-- Calibration Panel -->
    <div id="cal-panel">
      <div class="row">
        <label
          >Show guides <input type="checkbox" id="cal-toggle" checked
        /></label>
      </div>

      <!-- GUIDE CALIBRATION (affects ring/sector detection boundaries) -->
      <div class="row">
        <label for="cal-radius">Guide radius fudge</label>
        <input
          type="range"
          id="cal-radius"
          min="0.50"
          max="1.20"
          step="0.001"
          title="Scale the guide rings relative to the board image (0.50â€“1.20)"
        />
        <span class="val" id="cal-r-val">â€”</span>
      </div>
      <div class="row">
        <label for="cal-dx">Guide centre X (px)</label>
        <input type="number" id="cal-dx" min="-200" max="200" step="1" />
        <span class="val" id="cal-dx-val">â€”</span>
      </div>
      <div class="row">
        <label for="cal-dy">Guide centre Y (px)</label>
        <input type="number" id="cal-dy" min="-200" max="200" step="1" />
        <span class="val" id="cal-dy-val">â€”</span>
      </div>
      <div class="row">
        <label for="cal-rot">Guide rotation (deg)</label>
        <input type="number" id="cal-rot" min="-30" max="30" step="0.1" />
        <span class="val" id="cal-rot-val">â€”</span>
      </div>

      <!-- BOARD IMAGE CALIBRATION (visual only, does not affect detection) -->
      <div
        class="row"
        style="margin-top: 12px; border-top: 1px solid #444; padding-top: 8px"
      >
        <label for="cal-img-rot">Board image rotation (deg)</label>
        <input type="number" id="cal-img-rot" min="-180" max="180" step="0.1" />
        <span class="val" id="cal-img-rot-val">â€”</span>
      </div>
      <div class="row">
        <label for="cal-img-scale">Board image scale</label>
        <input
          type="number"
          id="cal-img-scale"
          min="0.7"
          max="1.3"
          step="0.001"
        />
        <span class="val" id="cal-img-scale-val">â€”</span>
      </div>
      <div class="row">
        <label for="cal-img-x">Board image X (px)</label>
        <input type="number" id="cal-img-x" min="-300" max="300" step="1" />
        <span class="val" id="cal-img-x-val">â€”</span>
      </div>
      <div class="row">
        <label for="cal-img-y">Board image Y (px)</label>
        <input type="number" id="cal-img-y" min="-300" max="300" step="1" />
        <span class="val" id="cal-img-y-val">â€”</span>
      </div>

      <div class="row">
        <button id="cal-save" class="btn">Save Calibration</button>
        <small id="cal-saved" style="opacity: 0.85"></small>
      </div>
      <div class="row">
        <div id="ruler" title="100 mm ruler for projector scale"></div>
        <small
          >On projector nights: adjust overall scale until this bar measures
          exactly 100 mm with a real ruler.</small
        >
      </div>
    </div>

    <!-- GAME HUD -->
    <section id="hud" class="hud">
      <div class="hud-row">
        <div class="hud-cell">Player: <span id="hud-player">P1</span></div>
        <div class="hud-cell">Target: <span id="hud-target">1</span></div>
        <div class="hud-cell">Throws left: <span id="hud-throws">3</span></div>
      </div>
      <div class="hud-row">
        <div id="status">Click the board to simulate a dart.</div>
      </div>
      <div class="hud-row">
        <div id="hit-log" class="hit-log" aria-live="polite"></div>
      </div>
    </section>

    <div
      id="hud-controls"
      class="hud-controls"
      style="
        position: fixed;
        left: 50%;
        transform: translateX(-50%);
        bottom: 16px;
        z-index: 3;
        display: flex;
        gap: 8px;
        padding: 6px 10px;
        border-radius: 999px;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(4px);
        align-items: center;
        justify-content: center;
      "
    >
      <button id="btn-start" type="button">Start</button>
      <button id="btn-capture" type="button">Capture Before</button>
      <button id="btn-detect" type="button">Detect Dart</button>
      <button id="btn-undo" type="button" disabled>Undo</button>
      <button id="btn-reset" type="button">Reset</button>
    </div>

    <audio id="sfx-hit" preload="auto" muted>
      <source
        src="{{ url_for('static', filename='sfx/hit.mp3') }}"
        type="audio/mpeg"
      />
      <source
        src="{{ url_for('static', filename='sfx/hit.ogg') }}"
        type="audio/ogg"
      />
    </audio>
    <audio id="sfx-bust" preload="auto" muted>
      <source
        src="{{ url_for('static', filename='sfx/bust.mp3') }}"
        type="audio/mpeg"
      />
      <source
        src="{{ url_for('static', filename='sfx/bust.ogg') }}"
        type="audio/ogg"
      />
    </audio>
    <audio id="sfx-win" preload="auto" muted>
      <source
        src="{{ url_for('static', filename='sfx/win.mp3') }}"
        type="audio/mpeg"
      />
      <source
        src="{{ url_for('static', filename='sfx/win.ogg') }}"
        type="audio/ogg"
      />
    </audio>
    <audio id="sfx-turn-atw" preload="auto" muted>
      <source
        src="{{ url_for('static', filename='sfx/PlayerChangeATW.mp3') }}"
        type="audio/mpeg"
      />
    </audio>

    <script>
      window.GAME_BOOT = {
        game: "{{ game }}",
        x01Start: {{ start }},
        doubleOut: {{ 'true' if double_out else 'false' }}
      };
    </script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
  </body>
</html>
